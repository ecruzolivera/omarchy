#!/bin/bash

set -e

COMMAND="$1"
OMARCHY_PATH=${OMARCHY_PATH:-$HOME/.local/share/omarchy}

if [[ -z $COMMAND ]]; then
  echo "Usage: omarchy-snapshot <create|restore>" >&2
  exit 1
fi

if ! command -v snapper &>/dev/null; then
  exit 127 # omarchy-update can use this to just ignore if snapper is not available
fi

case "$COMMAND" in
create)
  DESC="$(omarchy-version)"

  echo -e "\e[32mCreate system snapshot\e[0m"

  # Read snapper configs and their subvolume paths
  while IFS=, read -r name path _; do
    [[ $name == "Config" ]] && continue # Skip header
    # Check if the path exists and is btrfs
    if [[ -d $path ]] && [[ "$(findmnt -n -o FSTYPE --target "$path")" == "btrfs" ]]; then
      sudo snapper -c "$name" create -c number -d "$DESC"
    fi
  done < <(sudo snapper --csvout list-configs)
  echo
  ;;
restore)
  sudo limine-snapper-restore
  ;;
esac
